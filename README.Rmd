---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# gdm <img src="man/figures/gdmLogo.png" align="right" width="120" />

<!-- badges: start -->
[![CRAN_Status_Badge](https://www.r-pkg.org/badges/version/gdm?color=blue)](https://cran.r-project.org/web/packages/gdm)
[![Downloads](https://cranlogs.r-pkg.org/badges/gdm?color=blue)](https://cran.rstudio.com/package=gdm)
<!-- badges: end -->

The `gdm` package provides function to fit, plot, summarize, and apply Generalized Dissimilarity Models.

# Installation

The **gdm** package is available on CRAN, development versions are available on GitHub.

* Install from CRAN:

```{r loadPackages, warning=F, message=F, eval=F}
install.packages("gdm")
```

* Install latest development version from GitHub (requires [devtools](https://github.com/hadley/devtools) package):

```{r loadPackages, warning=F, message=F, eval=F}
if (!require("devtools")) {
  install.packages("devtools")
}
devtools::install_github("fitzLab-AL/gdm")
```

### Citations

Fitzpatrick MC, Mokany K, Manion G, Nieto-Lugilde D, Ferrier S. (2021) gdm: Generalized Dissimilarity Modeling. R package version 1.5.0.

Mokany K, Ware C, Woolley SNC, Ferrier S, Fitzpatrick MC (in revision) A working guide to generalized dissimilarity modelling.

Ferrier S, Manion G, Elith J, Richardson, K (2007) Using generalized dissimilarity modelling to analyse and predict patterns of beta diversity in regional biodiversity assessment. Diversity & Distributions 13: 252-264.

# Introduction

The R package **gdm** implements Generalized Dissimilarity Modeling [@ferrier_2007] to analyze and map spatial patterns of biodiversity. GDM models biological variation as a function of environment and geography using distance matrices â€“ specifically by relating biological dissimilarity between sites to how much sites differ in their environmental conditions (environmental distance) and how isolated they are from one another (geographical distance). Here we demonstrate how to fit, apply, and interpret GDM in the context of analyzing and mapping species-level patterns. GDM also can be used to model other biological levels of organization, notably genetic [@fitzpatrick_2015], phylogenetic [@rosauer_2014], or function/traits [@thomassen_2010]). The approaches for doing so  are largely identical to the species-level case and differ mainly in that the input biological data differ.  

##  Preparing the data for GDM: The site-pair table.

The initial step in fitting a generalized dissimilarity model is to combine the biological and environmental data into "site-pair" format using the `formatsitepair` function. 

GDM can use several data formats as input. Most common are site-by-species tables (sites in rows, species across columns) for the response and site-by-environment tables (sites in rows, predictors across columns) as the predictors, though distance matrices and rasters also are accommodated. 

The **gdm** package comes with two example biological data sets and two example environmental data sets in different formats. Example data include:
  - `southwest`: A data frame named that contains x-y coordinates, 10 columns of predictors (five soil and five bioclimatic), and occurrence data for plants from southwest Australia (representing a subset of the data used in [@fitzpatrick_2013]). Note that the format of the `southwest` table is an x-y species list (i.e., `bioFormat = 2`, see below) where there is one row *per species record rather than per site*. These biological data are similar to what would be obtained from online databases such as GBIF.
  - `gdmDissim`: A pairwise biological dissimilarity matrix for the species data provided in `southwest`. `gdmDissim` is provided to demonstrate how to proceed when you come to **gdm** with an existing biological distance matrix (e.g., pairwise Fst) as the response variable (i.e., `bioFormat = 3`, see below). Note however that distance matrices can also be used as predictors (e.g., to model compositional variation in one group as a function of compositional variation in another group [@jones_2013]).
  - `swBioclims`: a stack of five rasters for the five bioclimatic predictors provided in the `southwest` data.
  
Note that for all input data the rows and their order must match in the biological and environmental data frames and must not include NAs. This is best accomplished by making sure your tables have a column with a unique identifier for each site.  
  
To start, we need individual tables for the biological and environmental data, so we first index the `southwest` table to create two tables, one for the species data and the other for the environmental data:  

```{r prepEnvdata, warning=FALSE, message=FALSE}
library(gdm)
# have a look at the southwest data set
str(southwest)

# biological data
# get columns with xy, site ID, and species data
sppTab <- southwest[, c("species", "site", "Lat", "Long")]

# # columns 3-7 are soils variables, remainder are climate
# get columns with env. data and xy-coordinates
envTab <- southwest[, c(2:ncol(southwest))]
```

Because the `southwest` data are an x-y species list, we use `bioFormat=2` and provide the required column names to create the site-pair table: 

```{r sitepairTab, warning=FALSE, message=FALSE}
# x-y species list example
gdmTab <- formatsitepair(bioData=sppTab, 
                         bioFormat=2, #x-y spp list
                         XColumn="Long", 
                         YColumn="Lat",
                         sppColumn="species", 
                         siteColumn="site", 
                         predData=envTab)
```

Each row in the resulting site-pair table contains a biological distance measure in the first column (the default is Bray-Curtis distance though any measure scaled between 0-1 is acceptable). The second column contains the weight to be assigned to each data point in model fitting (defaults to 1 (equal weighting), but can be customized by the user or can be scaled to site richness, see below). The remaining columns are the environmental values at a site (s1) and those at a second site (s2) making up a site pair. Subsequent rows repeat this pattern until all possible site pairs are represented and such that pairwise distances between all sites can be calculated and used as predictors. While the site-pair table format can produce extremely large data frames and contain numerous repeat values, it also allows great flexibility. Most notably, individual site pairs easily can be excluded from model fitting.

A properly formatted site-pair table will have at least six columns (distance, weights, s1.xCoord, s1.yCoord, s2.xCoord, s2.yCoord) and possibly more depending upon how many predictor variables are included. See `?formatsitepair` and `?gdm` for more details.

```{r echo=F}
gdmTab[1:3,]
```

What if you already have a biological distance matrix because you are working with, say, genetic data? In that case, it is simple as changing the `bioFormat` argument **and also making sure the rows in your biological and envirnmental tables are in the same order**. Let's have a quick look at `gdmDissim`, the pairwise biological distance matrix:

```{r}
# Biological distance matrix example
dim(gdmDissim)
gdmDissim[1:5, 1:5]
```

We first need to bind a site ID column to `gdmDissim`. We already know the sites are in the correct order so we do not check, but you should for your data.

```{r}
# get the site column from sppTab
site <- unique(sppTab$site)
# bind to gdmDissim
gdmDissim <- cbind(site, gdmDissim)
gdmDissim[1:5, 1:5]
```

Now we are ready to use `formatsitepair`:

```{r}
gdmTab.dis <- formatsitepair(bioData=gdmDissim, 
                             bioFormat=3, #diss matrix 
                             XColumn="Long", 
                             YColumn="Lat", 
                             predData=envTab, 
                             siteColumn="site")
```

In addition to using tablular data, environmental data can be extracted directly from rasters, assuming x-y coordinates of sites are provided in either a site-species table (`bioFormat=1`) or as a x-y species list (`bioFormat=2`).

```{r sitepairRaster, warning=FALSE, message=FALSE}
# environmental raster data for sw oz
swBioclims <- raster::stack(system.file("./extdata/swBioclims.grd", package="gdm"))

gdmTab.rast <- formatsitepair(bioData=sppTab, 
                              bioFormat=2, # x-y spp list
                              XColumn="Long", 
                              YColumn="Lat", 
                              sppColumn="species",
                              siteColumn="site",
                              predData=swBioclims)

# make sure there are no NA values 
# e.g., if some sites do not intersect the rasters
sum(is.na(gdmTab.rast))
gdmTab.rast <- na.omit(gdmTab.rast)
```

Note that the `formatsitepair` function assumes that the coordinates of the sites are in the same coordinate system as the raster layers and, at present, no checking is performed to ensure this is the case. Note also that if your site coordinates are longitude-latitude that the calculation of geographic distances between sites will have errors, the size of which will depend on the geographic extent and location of your study region. We hope to deal with this in a later release, but for now you can avoid these problems by using a projected coordinate system.

## Dealing with biases associated with presence-only data

The ideal biological data for fitting a GDM are occurrence records (presence-absence or abundance) from a network of sites where all species (from one or more taxonomic groups) have been intensively sampled such that compositional dissimilarity can be reliably estimated between sites.  However most species data are collected as part of ad hoc surveys and are presence-only. Under these circumstances, there is no systematic surveying and no sites per se, but rather grid cells with some number of occurrence records depending on the number of species observed, with many grid cells having none, a few, or even a single species record. When under-sampled sites are used to calculate compositional dissimilarity, erroneously high values will result, which will bias the model. 

The `formatsitepair` function provides a few options for dealing with this potential bias, including (i) weighting sites relative to the number of species observed (`weightType="richness"`), (ii) removing sites with few species (e.g., `speciesFilter=10`) or (iii) both. Decisions regarding which approach to use will depend on the nature of the data and study system. See Ferrier et al. (2007) for further discussion.

```{r sitepairFilter, warning=FALSE, message=FALSE}
# weight by site richness using weightType="richness"
gdmTab.rw <- formatsitepair(bioData=sppTab, 
                            bioFormat=2, 
                            XColumn="Long", 
                            YColumn="Lat",
                            sppColumn="species", 
                            siteColumn="site", 
                            predData=envTab, 
                            weightType="richness")

# weights based on richness (number of species records)
gdmTab.rw[1:5, 1:5]
```

```{r sitepairFilter, warning=FALSE, message=FALSE, eval=F}
# remove sites with < 10 species records using
# sppFilter = 10
gdmTab.sf <- formatsitepair(bioData=sppTab, 
                            bioFormat=2, 
                            XColumn="Long", 
                            YColumn="Lat",
                            sppColumn="species", 
                            siteColumn="site", 
                            predData=envTab, 
                            sppFilter=10)
```

##  GDM fitting

GDM is a nonlinear extension of permutational matrix regression that uses flexible splines and a GLM to accommodate two types of nonlinearity common in ecological datasets: (1) variation in the rate of compositional turnover (non-stationarity) along environmental gradients, and (2) the curvilinear relationship between biological distance and environmental and geographical distance. 

The function `gdm` fits generalized dissimilarity models and is simple to use once the biological and predictor data have been formatted to a site-pair table. In addition to specifying whether or not the model should be fit with geographical distance as a predictor variable, the user can also specify (i) the number of I-spline basis functions (the default is three, with larger values producing more complex splines) and (ii) the locations of "knots" along the splines (defaults 0 (minimum), 50 (median), and 100 (maximum) quantiles when three I-spline basis functions are used). The effects (and significance) of altering the number of splines and knot locations has not been systematically explored.

```{r fitGDM, warning=FALSE, message=FALSE}
gdm.1 <- gdm(data=gdmTab, geo=TRUE)
```

The `summary` function provides an overview of the model, including deviance explained, the values of the coefficients for the I-spline for each predictor variable, and the sum of the I-spline coefficients for each predictor (an indicator of predictor importance, the summary prints predictors in order of the sum of the coefficients). Variables with all coefficients=0 have no relationship with the biological pattern. A shorter summary can be obtained using `str`. 

```{r summaryGDM, warning=FALSE, message=FALSE}
#summary(gdm.1)
str(gdm.1)
```

##  GDM plots

The fitted splines represent one of the most informative outputs from `gdm`, which also can be used to transform and map environmental variables such that they best represent biological patterns. The fitted model and I-splines can be viewed using the `plot` function, which produces a multi-panel plot that includes: (i) the fitted relationship between predicted ecological distance and observed compositional dissimilarity; (ii) predicted versus observed biological distance, and (iii) each I-spline with at least one non-zero coefficient, plotted in order by sum of the I-spline coefficients (in the provided example bio18 is not plotted because all three coefficients equaled zero).

The maximum height of each spline indicates the magnitude of total biological change along that gradient and thereby corresponds to the relative importance of that predictor in contributing to biological turnover while holding all other variables constant (i.e., is a partial ecological distance). The splineâ€™s shape indicates how the rate of biological change varies with position along that gradient. Thus, the splines provide insight into the total magnitude of biological change as a function of each gradient and where along each gradient those changes are most pronounced. In this example, compositional turnover is greatest along gradients of bio19 (winter precipitation) and phTotal (soil phosphorus) and most rapid near the low ends of these gradients.  

```{r plotGDM, warning=FALSE, message=FALSE, fig.height=9, fig.width=6, fig.cap="The fitted model (first two panels) and I-splines (remaining panels)."}
length(gdm.1$predictors) # get ideal of number of panels
plot(gdm.1, plot.layout=c(4,3))
```

To allow easy customization of I-spline plots, the `isplineExtract` function will extract the plotted values for each I-spline. 

```{r extractSplines, warning=FALSE, message=FALSE, fig.height=4, fig.width=4, fig.cap="Custom I-spline plot for geographic distance."}
gdm.1.splineDat <- isplineExtract(gdm.1)
str(gdm.1.splineDat)
plot(gdm.1.splineDat$x[,"bio19"], 
     gdm.1.splineDat$y[,"bio19"], 
     lwd=3,
     type="l", 
     xlab="Winter precipitation (mm)", 
     ylab="Partial ecological distance")
```

## GDM predictions

The I-splines provide an indication of how species composition (or other biological response variable) changes along each environmental gradient. Beyond these insights, a fitted model also can be used to (i) predict biological dissimilarity between site pairs in space or between times using the `predict` function and (ii) transform the predictor variables from their arbitrary environmental scales to a common biological importance scale using the `gdm.transform` function.  

The following examples show predictions between site pairs and through time, and transformation of both tabular and raster data. For the raster example, the transformed layers are used to map spatial patterns of biodiversity.    

##  Using a fitted GDM to predict biological dissimilarity between sites

The `predict` function requires a site-pair table in the same format as that used to fit the model. For demonstration purposes, we use the same table as that used to fit the model, though predictions to new sites (or times) can be made as well assuming the same set of environmental/spatial predictors are available at those locations (or times). 

```{r predictSpaceGDM, warning=FALSE, message=FALSE, fig.height=4, fig.width=4, fig.cap="Predicted vs. observed compositional dissimilarity."}
gdm.1.pred <- predict(object=gdm.1, data=gdmTab)

head(gdm.1.pred)

plot(gdmTab$distance, 
     gdm.1.pred, 
     xlab="Observed dissimilarity", 
     ylab="Predicted dissimilarity", 
     xlim=c(0,1), 
     ylim=c(0,1), 
     pch=20, 
     col=rgb(0,0,1,0.5))
lines(c(-1,2), c(-1,2))
```


\pagebreak  

## Examining variable uncertainty

Something about Uncertainty in predictive modeling?

The `plotUncertainty` function is provides a means to test the uncertainty in the values used to create a **gdm**. The function randomly removes sites from a given site-pair table equal to a number of defined iterations [@shryock_2015] (??). Each iteration the remaining sites are used to construct a new site-pair table, which is then used to fit a **gdm**. The I-spline values are extracted from each **gdm** and used to plot a cloud of uncertainty for each variable with, the cloud representing one standard deviation, and a solid line plotted along the mean. In addition, a rug plot is provided in order to see the actual distribution of the data from the given site-pair table.

While not demonstrated here, the `plotUncertainty` function has the option to be ran in parallel utalizing an internal `foreach` loop. Using the functions multicore capabilities is highly recommended for a large number of iterations. 

```{r plotUncertainty, warning=FALSE, message=FALSE, fig.height=9, fig.width=6, fig.cap="Plotted uncertainty of the I-spline data."}
# using the formated site-pair table from above
plotUncertainty(gdmTab, geo=T, leaveOut=0.35, bsIters=5, plot.layout=c(4,3))
```

\pagebreak

## **gdm** predictions

The I-splines provide an indication of how species composition (or other biological measure) changes along each environmental gradient. Beyond these insights, a fitted model also can be used to (i) predict biological dissimilarity between site pairs in space or between times using the `predict` function and (ii) transform the predictor variables from their arbitrary environmental scales to a common biological importance scale using the `transform` function.  

The examples show predictions between site pairs and through time, and transformation of both tabular and raster data. Fr the raster example, the transformed layers are used to map spatial patterns of biodiversity.    

##  Predicting biological distances between sites

The `predict` function requires a site-pair table in the same format as that used to fit the model. For demonstration purposes, we use the same table as that used to fit the model, though predictions to new sites (or times) can be made as well assuming the same set of environmental/spatial predictors are available at those locations (or times). 

```{r predictSpaceGDM, warning=FALSE, message=FALSE, fig.height=4, fig.width=4, fig.cap="Predicted vs. observed compositional dissimilarity."}
gdm.1.pred <- predict(gdm.1, gdmTab)
head(gdm.1.pred)
plot(gdmTab$distance, gdm.1.pred, xlab="Observed dissimilarity", 
     ylab="Predicted dissimilarity", xlim=c(0,1), ylim=c(0,1), pch=20, col=rgb(0,0,1,0.5))
lines(c(-1,2), c(-1,2))
```

##  Predicting biological change through time

The `predict` function can be used to make predictions across time [@blois_2013], for example, under climate change scenarios to estimate the magnitude of expected change in biological composition in response to environmental change [@fitzpatrick_2011]. In this case, rasters must be provided for two time periods of interest.

```{r predictTimeGDM, warning=FALSE, message=FALSE, fig.height=4, fig.width=4, fig.cap="Predicted magnitude of biological change through time"}
# fit a new gdm using a table with climate data only (to match rasters)
gdm.rast <- gdm(gdmTab.rast, geo=T)

# make some fake climate change data
futRasts <- envRast
##reduce winter precipitation by 25% & increase temps
futRasts[[3]] <- futRasts[[3]]*0.75
futRasts[[4]] <- futRasts[[4]]+2
futRasts[[5]] <- futRasts[[5]]+3

timePred <- predict(gdm.rast, envRast, time=T, predRasts=futRasts)
plot(timePred)
```

##  Transforming predictors and visualizing biological patterns

### Transforming from environmental space to biological space

Predictor data to be transformed can be in one of two formats: a data frame with columns in the order of: X, Y, var1, var2, ..., varN, or a raster stack or brick with one layer per predictor. Beyond the x- and y-columns in the data frame, the order of the predictor data (columns for tabular data, layers for rasters) must be the same as that in the site-pair table used in model fitting. If the model was fit *without* using geographical distance, then the x- and y-columns of the data frame should not be included in the predictor data. If the model was fit *with* geographical distance and raster data are provided to the `transform` function, there is no need to provide x- or y-raster layers as these will be generated automatically . However, the character names of the x- and y-coordinates (e.g., "Lat" and "Long") used to fit the model need to be provided.

```{r transformGDM, warning=FALSE, message=FALSE, fig.height=4, fig.width=6.5, fig.width=3.5}
# reordering environmental data to create table for transformation
envTrans <- envTab[, c(13,12,2:11)] # same order as gdmTab
envTrans[1:3,]

tabTrans <- gdm.transform(gdm.1, envTrans)
# now scaled to biological importance
tabTrans[1:3,]

# transform climate rasters & plot pattern
rastTrans <- gdm.transform(gdm.rast, envRast)
#plot(rastTrans)
```

### Visualizing multi-dimensional biological patterns

Pairwise site biological distances are difficult to visualize. However, if the `transform` function is applied to rasters, the resulting multi-dimensional biological space can be mapped to reveal biological patterns in geographic space. Alternatively, a biplot can be used to depict where sites fall relative to each other in biological space and therefore how sites differ in predicted biological composition. In either case, the multi-dimensional biological space can be most effectively visualized by taking a PCA to reduce dimensionality and assigning the first three components to an RGB color palette.   

```{r, warning=FALSE, message=FALSE, fig.height=3, fig.width=3, fig.cap="Predicted spatial variation in plant species composition. Colors represent gradients in species composition derived from transformed environmental predictors. Locations with similar colors are expected to contain similar plant communities."}
rastDat <- na.omit(getValues(rastTrans))
#rastDat <- sampleRandom(rastTrans, 50000) # can use if rasters are large
pcaSamp <- prcomp(rastDat)
 
# note the use of the 'index' argument
pcaRast <- predict(rastTrans, pcaSamp, index=1:3)

# scale rasters
pcaRast[[1]] <- (pcaRast[[1]]-pcaRast[[1]]@data@min) /
  (pcaRast[[1]]@data@max-pcaRast[[1]]@data@min)*255
pcaRast[[2]] <- (pcaRast[[2]]-pcaRast[[2]]@data@min) /
  (pcaRast[[2]]@data@max-pcaRast[[2]]@data@min)*255
pcaRast[[3]] <- (pcaRast[[3]]-pcaRast[[3]]@data@min) /
  (pcaRast[[3]]@data@max-pcaRast[[3]]@data@min)*255

plotRGB(pcaRast, r=1, g=2, b=3)
```

\pagebreak  

# **gdm** Variable Importance

Something about variable importance? 

The `gdm.varImp` function performs matix permutation on a given site-pair table to estimate the importance/significance of the variables used to fit a **gdm**. The function's output is a list of three tables. The first table is summarizes the model deviance, percent deviance explained, and estimated p-value from the number of variables that are considered available to fit a model. The remaining two tables summarize variable importance and significance respectively. Variable importance is measured as the amount full model deviance is reduced when that variable is removed. Significance is estimated using the bootstrapped p-value when the variable has been removed. 

When the fullModelOnly argument for the `gdm.varImp` function is set to TRUE, the function will evaluate only the "fullModel", or the **gdm** object that results from the given site-pair table with all variables included, and only the first column of the output tables will have values. When the fullModelOnly argument is set to FALSE, then the function will use a backward elimination process to remove variables one at a time and re-examine the fitted model with the remaining variables. In the output tables, this is labeled with "fullModel-X", where X is the number of variables which have been removed. During the backward selection process, the variable which is considered least important (first greatest P-value, then lowest reduced deviance) is the variable which is selected for removal. 

```{r variableImportance, warning=FALSE, message=FALSE}
# using the formated site-pair table from above
varSig <- gdm.varImp(gdmTab, geo=T, nPerm=5, fullModelOnly=F)
varSig[[1]]
varSig[[2]]
varSig[[3]]
```

\pagebreak

# Vertical **gdm**, a theoretical analysis

The original intent of **gdm** was to measure the dissimilarity of sites along geogrphic distance. However, a valid inquerry could be the dissimilarity of biota at the same geographic location. One example of this could be an analysis examining the community dissimilarity of species at various hieghts within a tree canopy. Geographically, the tree would remain in once place, but different sites could be designated by thier hieght above the ground. The challenge with this scenerio is that having multiple sites associated with a single pair of coordinates has a tendency to confuse the `formatsitepair` function. This is an example of how one could work around this limitation.

To begin with, some data is required:

```{r mockVertData, warning=FALSE, message=FALSE}
# create mock vertical data for analysis
site <- c("tree1-1","tree1-2","tree1-3","tree1-4","tree2-1","tree2-2","tree2-3","tree3-1","tree3-2","tree4-1","tree4-2","tree4-3","tree4-4","tree4-5","tree5-1","tree5-2")
xCoord <- c(-90.087,-90.087,-90.087,-90.087,-90.19,-90.19,-90.19,-90.021,-90.021,-90.021,-90.021,-90.021,-90.021,-90.021,-89.7,-89.7)
yCoord <- c(43.051,43.051,43.051,43.051,42.994,42.994,42.994,42.928,42.928,44.053,44.053,44.053,44.053,44.053,42.881,42.881)
spp1 <- c(0,0,3,1,0,0,0,0,0,0,0,0,2,1,0,0)
spp2 <- c(5,3,0,0,0,0,0,9,8,6,5,2,0,1,7,0)
spp3 <- c(1,0,0,0,1,0,0,1,0,1,0,0,0,0,1,0)
spp4 <- c(3,2,1,0,0,1,0,6,2,3,4,2,0,0,3,1)
spp5 <- c(0,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0)
spp6 <- c(0,0,0,0,1,1,1,0,0,0,0,0,0,0,1,1)
spp7 <- c(6,5,2,1,6,3,0,0,1,0,5,4,1,0,4,0)
leafAreaIndex <- c(0,0.89,1.01,1.45,0,0.69,1.32,0.05,0.8,0,0.6,1.5,1.8,0.9,0.15,0.64)
height <- c(5,11,21,36,5,13,26,5,11,5,9,22,35,42,5,12)

treeTab <- data.frame(site,xCoord,yCoord,spp1,spp2,spp3,spp4,spp5,spp6,spp7,leafAreaIndex,height, stringsAsFactors=F)
```

In order to give each site its own set of unique coordinates, a base function called `jitter` will be utalized. `jitter` adds an amount of noise to numeric data, which can be handy in intentinally introducing small amounts of error to data or in creating unique values. 

```{r jitterCoords, warning=FALSE, message=FALSE}
# create a copy of the data object in order to preserve the original
jitterTree <- treeTab
# apply `jitter` function to the coordinates of the data table
jitterTree$xCoord <- jitter(jitterTree$xCoord, 0.01)
jitterTree$yCoord <- jitter(jitterTree$yCoord, 0.001)

# test to make sure that actually have the correct number of unique coordinates
# if this line does not equal TRUE, rerun the above
nrow(unique(treeHold[,c("xCoord", "yCoord")]))==nrow(treeHold)
```

With unique coordinates, then the **gdm** analysis can proceed as normal.

```{r fitVerticalGDM, warning=FALSE, message=FALSE}
# create biological and environmental data tables
treeSpp <- jitterTree[,c("site", "xCoord", "yCoord", "spp1", "spp2", "spp3", "spp4", "spp5", "spp6", 
                         "spp7")]
treeEnv <- jitterTree[,c("site", "xCoord", "yCoord", "leafAreaIndex", "height")]

# create site-pair table
treePair <- formatsitepair(treeSpp, bioFormat=1, abundance=T, siteColumn="site", XColumn="xCoord",
                            YColumn="yCoord", predData=treeEnv)
# fit vertical **gdm**
treeGDM <- gdm(testPair, geo=T)
str(treeGDM)
```

# References


Geographical distance measures can be simple Euclidean separation or more complex measures of isolation, such as least cost paths or resistance distance. See [@ferrier_2007] for strategies for including categorical variables. 
